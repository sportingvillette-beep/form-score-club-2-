<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sporting Villette — Saisie score & photo</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      /* Palette club (accessible clair/sombre) */
      --brand:#b9314f;         /* primaire */
      --brand-2:#d9a05b;       /* accent */
      --bg:#f7f5f5;            /* fond clair */
      --text:#1d1d1f;          /* texte clair */
      --muted:#6b7280;
      --ok:#2da160;            /* succès clair */
      --err:#b00020;           /* erreur */
      --card:#ffffff;          /* carte clair */
      --border:#e5e7eb;        /* bordure clair */
      --input-bg:#ffffff;      /* input clair */
      --live:#d32f2f;
      --wait:#9a6b00;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f0f10; --text:#f7f5f5; --card:#151516; --border:#2a2a2b; --input-bg:#101011; --ok:#74d59f; --muted:#9aa3b2 }
    }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:520px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(2,6,23,.08);padding:18px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    header img{width:40px;height:40px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
    header .club{font-weight:800;letter-spacing:.2px}
    header .hint{font-size:12px;color:var(--muted)}

    h3{margin:8px 0 10px}
    .muted{color:var(--muted);font-size:12px}

    /* Liste de matchs (mobile-first) */
    .matches .list{display:grid;gap:10px;margin-bottom:10px}
    .match-card{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;border:1px solid var(--border);border-radius:14px;background:var(--card);cursor:pointer}
    .match-card:active{transform:scale(.99)}
    .mc-left{display:grid;gap:4px;text-align:left}
    .mc-title{font-weight:800}
    .mc-sub{font-size:12px;color:var(--muted);display:flex;flex-wrap:wrap;gap:8px}
    .mc-right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.2px;padding:4px 8px;border-radius:999px;border:1px solid transparent}
    .b-live{color:#fff;background:var(--live)}
    .b-wait{color:#fff;background:var(--wait)}
    .b-id{font-size:11px;background:transparent;border:1px solid var(--border);color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%;background:#fff;box-shadow:0 0 0 2px rgba(255,255,255,.25)}
    .dot::after{content:'';display:block;width:8px;height:8px;border-radius:50%;background:#fff;opacity:.35;animation:pulse 1.2s infinite ease-out}
    @keyframes pulse{0%{transform:scale(1)}100%{transform:scale(2.2);opacity:0}}

    .scorechip{font-weight:800}
    .selected{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:10px 0 6px;padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:rgba(185,49,79,.06)}
    .sel-teams{font-weight:800}
    .mini{padding:8px 10px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border:none}

    form{display:grid;gap:10px;margin-top:6px}
    label{display:grid;gap:6px;font-size:15px}
    input,select,button{font-size:18px;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:var(--input-bg);color:var(--text)}
    input::placeholder{color:var(--muted)}
    input[type="file"]{padding:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row.one{grid-template-columns:1fr}
    .actions{display:grid;gap:8px}
    button{cursor:pointer;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border:none;font-weight:800;border-radius:12px}
    button[disabled]{opacity:.6;cursor:progress}

    .dropzone{border:2px dashed var(--border);border-radius:14px;padding:14px;text-align:center;background:rgba(185,49,79,.06)}
    .dropzone.drag{border-color:var(--brand);background:rgba(185,49,79,.12)}
    .dz-title{font-size:14px;font-weight:700}
    #preview,#preview2{max-width:100%;max-height:220px;border-radius:12px;display:none;margin-top:8px;border:1px solid var(--border)}

    .msg{min-height:20px}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    footer{margin-top:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <img id="clubLogo" alt="Logo du club" src="logo.png" onerror="this.style.display='none'" />
        <div>
          <div class="club" id="clubName">Sporting Villette</div>
          <div class="hint">Saisie du score & photo — mobile</div>
        </div>
      </header>

      <!-- Sélecteur de rencontre -->
      <section id="picker" class="matches">
        <h3>Choisir une rencontre</h3>
        <div id="matchesMsg" class="muted">Chargement des matchs…</div>
        <div id="matchesList" class="list" aria-live="polite"></div>
      </section>

      <!-- Détail de la rencontre sélectionnée -->
      <div id="selected" class="selected" hidden>
        <div class="sel-top">
          <div class="sel-teams" id="selTeams"></div>
          <div class="muted" id="selMeta"></div>
        </div>
        <button type="button" id="changeBtn" class="mini">Changer</button>
      </div>

      <!-- Formulaire score -->
      <form id="f" novalidate>
        <label id="idLine">ID match
          <input name="match_id" id="match_id" required placeholder="ex: MCH-2025-08-12-001" autocomplete="off">
        </label>
        <div class="row">
          <label><span id="label_dom">Score domicile</span>
            <input type="number" name="score_dom" id="score_dom" inputmode="numeric" min="0" max="200" required>
          </label>
          <label><span id="label_ext">Score extérieur</span>
            <input type="number" name="score_ext" id="score_ext" inputmode="numeric" min="0" max="200" required>
          </label>
        </div>

        <div class="row one">
          <label>Temps de jeu (optionnel, minutes)
            <input type="number" name="temps_jeu" id="temps_jeu" inputmode="numeric" min="1" max="90" placeholder="ex : 20">
          </label>
        </div>

        <label>Résultat
          <select name="statut" id="statut" required style="pointer-events:none;opacity:.9">
            <option value="" disabled selected>— Calculé automatiquement —</option>
            <option>Victoire</option>
            <option>Défaite</option>
            <option>Match Nul</option>
          </select>
        </label>

        <div class="dropzone" id="dz">
          <div class="dz-title">Photo du match (facultatif)</div>
          <input type="file" name="photo" id="photo" accept="image/*">
          <div class="muted">Glissez une image, prenez une photo ou choisissez depuis la galerie.</div>
          <img id="preview" alt="Aperçu photo" />
        </div>

        <input type="hidden" name="form_secret" id="form_secret" value="CHANGE-MOI">

        <div class="actions">
          <button type="submit" id="btn">Envoyer score</button>
          <div class="msg muted" id="msg" role="status" aria-live="polite"></div>
        </div>
      </form>

      <!-- Formulaire photo supplémentaire (match terminé) -->
      <form id="fPhoto" class="mt" hidden>
        <h3>Photo supplémentaire (match terminé)</h3>
        <div class="dropzone" id="dz2">
          <div class="dz-title">Ajouter une photo</div>
          <input type="file" name="photo_finale" id="photo2" accept="image/*">
          <div class="muted">Cette photo partira vers l’archivage (Dropbox).</div>
          <img id="preview2" alt="Aperçu photo" />
        </div>
        <div class="actions">
          <button type="submit" id="btn2">Envoyer photo</button>
          <div class="msg muted" id="msg2" role="status" aria-live="polite"></div>
        </div>
      </form>

      <footer class="muted">Astuce : créez un QR code vers cette page. La liste affiche automatiquement les matchs de J-5 à J+2.</footer>
    </div>
  </div>

  <script>
    // ======== CONFIGURATION ========
    const CONFIG = {
      clubName: 'Sporting Villette',
      logoUrl: 'logo.png',
      webhookScoreUrl: 'https://hook.eu2.make.com/12s2f2licqusjj1xiw3p3tulrfnd5dgw',
      webhookPhotoUrl: 'https://hook.eu2.make.com/40xiygzru2pfcgwooofj7ewouwqqddsi',
      maxSizeMB: 10,
      renameUploads: true,
      // CSV publié de l'onglet "Com matchs réseaux"
      gsheetCsvUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvskuueB25qKj0hbDWjFPomFdhfWRduUsNLp6Kv-za4t4oXcbbLsLrNsjwIt0ZH7C9B75pYBGDJfQu/pub?gid=0&single=true&output=csv',
      // Mappage des colonnes
      fields: {
        match_id:'Code Gesthand',
        date:'Date',
        heure:'Heure',
        categorie:'Catégorie',
        championnat:'Championnat',
        equipe1:'Eq1',
        equipe1x:'Eq1X',
        equipe2:'Eq2',
        equipe2x:'Eq2X',
        eq1score:'Eq1Score',
        eq2score:'Eq2Score',
        winlose:'WinLose',
        gymnase:'Gymnase',
        ville:'Ville'
      },
      // Aliases qui identifient "le club" pour calculer Victoire/Défaite automatiquement
      clubAliases: ['Sporting Villette','Villette Genas','Entente Villette Genas','Est Lyonnais','Lyon Est Handball'],
      // Fenêtre de dates : J-5 à J+2 (week-end typique)
      dateWindow: { pastDays: 5, futureDays: 2 },
      // Seuils pastilles LIVE / Attente
      liveThresholdMin: 90, // 1h30
    };
    // ================================

    // Identité visuelle
    (function initBrand(){ if (CONFIG.clubName) document.getElementById('clubName').textContent = CONFIG.clubName; if (CONFIG.logoUrl){ const img=document.getElementById('clubLogo'); img.src=CONFIG.logoUrl; } })();

    // ---- Utils ----
    function norm(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
    function slugify(s){ return String(s||'').trim().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').toUpperCase(); }
    function extFrom(type,fallback){ if(!type) return fallback||'jpg'; if(type==='image/jpeg')return'jpg'; if(type==='image/png')return'png'; if(type==='image/webp')return'webp'; if(type==='image/heic'||type==='image/heif')return'heic'; return fallback||'jpg'; }

    function parseDateFR(val){ // "DD/MM/YYYY"
      if(!val) return null;
      const fr = String(val).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      if (fr){ const d=fr[1].padStart(2,'0'), m=fr[2].padStart(2,'0'), y=fr[3]; return new Date(`${y}-${m}-${d}T00:00:00`); }
      const d=new Date(val); return isNaN(d)?null:d;
    }
    function parseDateTimeFR(dateStr, timeStr){ // "DD/MM/YYYY", "HH:MM"
      const d = parseDateFR(dateStr); if(!d) return null;
      const [h='00',m='00']=String(timeStr||'00:00').split(':');
      const dt=new Date(d); dt.setHours(parseInt(h,10)||0, parseInt(m,10)||0, 0, 0);
      return dt;
    }
    function fmtDate(d){ return d?d.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'short'}) : ''; }
    function fmtTime(d){ return d?d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}) : ''; }
    function sameDay(a,b){ return a && b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function inWindow(d){ const base=new Date(); base.setHours(0,0,0,0); const start=new Date(base); start.setDate(start.getDate()-(CONFIG.dateWindow.pastDays||5)); const end=new Date(base); end.setDate(end.getDate()+(CONFIG.dateWindow.futureDays||2)); return d>=start && d<=end; }
    function csvToRows(csv){ const rows=[]; let cur=[],i=0,field='',inq=false; while(i<csv.length){ const c=csv[i++]; if(c==='"'){ if(inq && csv[i]==='"'){ field+='"'; i++; } else { inq=!inq; } } else if(c===',' && !inq){ cur.push(field); field=''; } else if((c==='\n'||c==='\r') && !inq){ if(field!==''||cur.length){ cur.push(field); rows.push(cur); cur=[]; field=''; } } else { field+=c; } } if(field!==''||cur.length){ cur.push(field); rows.push(cur); } return rows.filter(r=>r.length && r.join('').trim()!==''); }

    // ---- Sélecteur de matchs (lecture CSV) ----
    const matchesMsg = document.getElementById('matchesMsg');
    const matchesList = document.getElementById('matchesList');
    const idLine = document.getElementById('idLine');
    const selectedBox = document.getElementById('selected');
    const selTeams = document.getElementById('selTeams');
    const selMeta = document.getElementById('selMeta');
    const changeBtn = document.getElementById('changeBtn');

    async function loadMatches(){
      const url=CONFIG.gsheetCsvUrl; if(!url){ matchesMsg.textContent="Configurez CONFIG.gsheetCsvUrl (CSV publié)."; return; }
      try{
        matchesMsg.textContent='Chargement…';
        const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('CSV introuvable');
        const csv=await res.text();
        const rows=csvToRows(csv);
        const headers=rows.shift().map(h=>h.trim());
        const idx=Object.fromEntries(headers.map((h,i)=>[h.toLowerCase(),i]));
        const F=CONFIG.fields; const L=Object.fromEntries(Object.entries(F).map(([k,v])=>[k,(v||'').toLowerCase()]));

        const items=rows.map(r=>{
          const d = r[idx[L.date]];
          const h = r[idx[L.heure]];
          const dt = parseDateTimeFR(d,h);
          const e1 = (r[idx[L.equipe1]]||'').trim();
          const e1x = (r[idx[L.equipe1x]]||'').trim();
          const e2 = (r[idx[L.equipe2]]||'').trim();
          const e2x = (r[idx[L.equipe2x]]||'').trim();
          const e1label = (e1 + (e1x?` ${e1x}`:'' )).trim();
          const e2label = (e2 + (e2x?` ${e2x}`:'' )).trim();
          const eq1score = r[idx[L.eq1score]];
          const eq2score = r[idx[L.eq2score]];
          const winlose = r[idx[L.winlose]];
          return {
            match_id: r[idx[L.match_id]],
            date_str: d, heure_str: h,
            _date: dt, categorie: r[idx[L.categorie]], championnat: r[idx[L.championnat]],
            equipe1: e1label, equipe2: e2label,
            eq1score, eq2score, winlose,
            gymnase: r[idx[L.gymnase]], ville: r[idx[L.ville]]
          };
        }).filter(x=>x&&x.match_id);

        const filtered = items.filter(x=>x._date && inWindow(new Date(x._date)));
        filtered.sort((a,b)=>a._date-b._date);

        // cache pour recherche par ID
        window.__csv_cache = { rows, idx, fields:L, headers };

        renderMatches(filtered);
      }catch(err){ console.error(err); matchesMsg.textContent = "Impossible de charger la liste des matchs."; }
    }

    function isFinished(winlose){
      if(!winlose) return false;
      const n = norm(winlose);
      // Si winlose contient "victoire", "defaite", "match nul", "termine" => terminé
      if (/(victoire|defaite|défaite|match\s*nul|termine|terminé)/i.test(winlose)) return true;
      // Si c'est du type "20e" => en cours
      if (/^\d{1,2}e$/.test(n)) return false;
      // Sinon, toute valeur non vide est considérée "terminé"
      return true;
    }

    function liveBadge(m){
      const now=new Date();
      if (!m._date) return null;
      if (!sameDay(m._date, now)) return null;
      if (now < m._date) return null; // pas commencé
      const mins = Math.floor((now - m._date)/60000);
      if (isFinished(m.winlose)) return null;
      if (mins <= (CONFIG.liveThresholdMin||90)) return {type:'live', label:'LIVE'};
      return {type:'wait', label:'Attente score'};
    }

    function scoreText(m){
      const s1 = (m.eq1score!==undefined && m.eq1score!==null && String(m.eq1score).trim()!=='') ? m.eq1score : null;
      const s2 = (m.eq2score!==undefined && m.eq2score!==null && String(m.eq2score).trim()!=='') ? m.eq2score : null;
      if (s1!==null && s2!==null) return `${s1}–${s2}`;
      // Si pas de score mais winlose = "20e", l'afficher
      if (m.winlose && /^\s*\d{1,2}e\s*$/i.test(m.winlose)) return `${m.winlose.trim()} · en cours`;
      return '';
    }

    function renderMatches(list){
      matchesList.innerHTML='';
      if(!list.length){ matchesMsg.textContent='Aucun match dans la fenêtre sélectionnée.'; return; }
      matchesMsg.textContent='';

      const frag=document.createDocumentFragment();
      list.forEach(m=>{
        const badge=liveBadge(m);
        const score=scoreText(m);
        const card=document.createElement('button'); card.type='button'; card.className='match-card';

        const rightBits=[];
        if (score) rightBits.push(`<div class="scorechip">${score}</div>`);
        if (badge && badge.type==='live') rightBits.push(`<div class="badge b-live"><span class="dot"></span>${badge.label}</div>`);
        if (badge && badge.type==='wait') rightBits.push(`<div class="badge b-wait">${badge.label}</div>`);
        rightBits.push(`<div class="badge b-id">${m.match_id}</div>`);

        card.innerHTML=`<div class="mc-left">
            <div class="mc-title">${(m.equipe1||'').trim()} <span class="muted">vs</span> ${(m.equipe2||'').trim()}</div>
            <div class="mc-sub">
              <span>${fmtDate(m._date)} ${fmtTime(m._date)}</span>
              ${m.categorie?`<span>${m.categorie}</span>`:''}
              ${m.championnat?`<span>${m.championnat}</span>`:''}
              ${m.ville?`<span>${m.ville}</span>`:''}
            </div>
          </div>
          <div class="mc-right">${rightBits.join('')}</div>`;
        card.addEventListener('click',()=>selectMatch(m));
        frag.appendChild(card);
      });
      matchesList.appendChild(frag);
    }

    function selectMatch(m){
      selTeams.textContent = `${(m.equipe1||'').trim()} vs ${(m.equipe2||'').trim()}`;
      const metaParts=[fmtDate(m._date), fmtTime(m._date), (m.categorie||''), (m.championnat||''), (m.ville||'')].filter(Boolean);
      selMeta.textContent = metaParts.join(' · ');
      selectedBox.hidden = false; idLine.style.display = 'none';
      document.getElementById('match_id').value = m.match_id || '';
      setTeamLabels(m.equipe1,m.equipe2);
      computeResult();
      // Si déjà terminé => afficher form photo supplémentaire
      togglePhotoForm(isFinished(m.winlose), m);
      document.getElementById('f').scrollIntoView({behavior:'smooth',block:'start'});
    }

    function togglePhotoForm(show, m){
      const box=document.getElementById('fPhoto');
      box.hidden = !show;
      box.dataset.mid = m?.match_id || '';
      box.dataset.e1 = m?.equipe1 || '';
      box.dataset.e2 = m?.equipe2 || '';
      box.dataset.meta = `${fmtDate(m?._date)} ${fmtTime(m?._date)} · ${(m?.categorie||'')} · ${(m?.championnat||'')}`;
    }

    changeBtn.addEventListener('click',()=>{
      selectedBox.hidden=true; idLine.style.display='';
      document.getElementById('match_id').value='';
      setTeamLabels('domicile','extérieur'); statutEl.value='';
      togglePhotoForm(false);
    });

    // ---- Étiquettes dynamiques + résultat auto ----
    const labelDom=document.getElementById('label_dom');
    const labelExt=document.getElementById('label_ext');
    const inputId=document.getElementById('match_id');
    const sdEl=document.getElementById('score_dom');
    const seEl=document.getElementById('score_ext');
    const statutEl=document.getElementById('statut');
    const tempsEl=document.getElementById('temps_jeu');

    function setTeamLabels(eq1,eq2){ if(eq1) labelDom.textContent=`Score ${eq1}`; if(eq2) labelExt.textContent=`Score ${eq2}`; }

    const CLUBS=(CONFIG.clubAliases||[]).map(norm);
    function computeResult(){
      const s1=parseInt(sdEl.value,10), s2=parseInt(seEl.value,10);
      if(Number.isNaN(s1)||Number.isNaN(s2)){ statutEl.value=''; return; }
      if(s1===s2){ statutEl.value='Match Nul'; return; }
      const eq1=(labelDom.textContent||'').replace(/^Score\s+/,''), eq2=(labelExt.textContent||'').replace(/^Score\s+/,'');

      const isClub1=CLUBS.some(a=>norm(eq1).includes(a));
      const isClub2=CLUBS.some(a=>norm(eq2).includes(a));
      if(s1>s2){ if(isClub1) statutEl.value='Victoire'; else if(isClub2) statutEl.value='Défaite'; else statutEl.value='Terminé'; }
      else { if(isClub2) statutEl.value='Victoire'; else if(isClub1) statutEl.value='Défaite'; else statutEl.value='Terminé'; }
    }

    // Recherche d'équipes par ID si saisi à la main
    async function lookupTeamsById(id){
      try{
        const c=window.__csv_cache; if(!c) return;
        const F=c.fields;
        const mi=c.idx[(F.match_id||'')];
        const e1=c.idx[(F.equipe1||'')], e1x=c.idx[(F.equipe1x||'')];
        const e2=c.idx[(F.equipe2||'')], e2x=c.idx[(F.equipe2x||'')];
        const row=c.rows.find(r=>String(r[mi]).trim()===id.trim());
        if(row){
          const e1label = [row[e1], row[e1x]].filter(Boolean).join(' ').trim();
          const e2label = [row[e2], row[e2x]].filter(Boolean).join(' ').trim();
          setTeamLabels(e1label, e2label);
        }
      }catch(e){}
    }

    // Préremplissage optionnel via URL (?match_id=...&eq1=...&eq2=...)
    (function prefill(){
      const p=new URLSearchParams(location.search);
      const id=p.get('match_id'); if(id){ inputId.value=id; }
      const e1=p.get('eq1'), e2=p.get('eq2'); if(e1||e2) setTeamLabels(e1,e2);
    })();

    let t=null; inputId.addEventListener('input',()=>{ clearTimeout(t); const id=inputId.value.trim(); if(!id) return; t=setTimeout(()=>lookupTeamsById(id),400); });
    inputId.addEventListener('blur',()=>{ const id=inputId.value.trim(); if(id) lookupTeamsById(id); });
    sdEl.addEventListener('input', computeResult);
    seEl.addEventListener('input', computeResult);

    // Charger la liste au démarrage
    loadMatches();

    // ---- Drag & drop & preview (form 1) ----
    ;(function dropZone(){
      const dz=document.getElementById('dz');
      const file=document.getElementById('photo');
      const prev=document.getElementById('preview');
      ['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.add('drag')}));
      ['dragleave','drop'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.remove('drag')}));
      dz.addEventListener('drop',e=>{ if(e.dataTransfer.files?.length){ file.files=e.dataTransfer.files; file.dispatchEvent(new Event('change')); } });
      file.addEventListener('change',()=>{ const f=file.files[0]; if(!f){ prev.style.display='none'; prev.src=''; return; } prev.src=URL.createObjectURL(f); prev.style.display='block'; });
    })();

    // ---- Drag & drop & preview (form 2) ----
    ;(function dropZone2(){
      const dz=document.getElementById('dz2');
      const file=document.getElementById('photo2');
      const prev=document.getElementById('preview2');
      ['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.add('drag')}));
      ['dragleave','drop'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.remove('drag')}));
      dz.addEventListener('drop',e=>{ if(e.dataTransfer.files?.length){ file.files=e.dataTransfer.files; file.dispatchEvent(new Event('change')); } });
      file.addEventListener('change',()=>{ const f=file.files[0]; if(!f){ prev.style.display='none'; prev.src=''; return; } prev.src=URL.createObjectURL(f); prev.style.display='block'; });
    })();

    // ---- Soumission SCORE ----
    const form=document.getElementById('f');
    const msg=document.getElementById('msg');
    const btn=document.getElementById('btn');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault(); msg.textContent='';
      const id=inputId.value.trim(); const sd=sdEl.value; const se=seEl.value;
      if(!id||sd===''||se===''){ msg.textContent='Merci de compléter tous les champs requis.'; msg.className='msg err'; return; }

      computeResult(); // sécurité
      const tmin = document.getElementById('temps_jeu').value.trim();

      // Taille fichier
      const inputFile=document.getElementById('photo'); const f=inputFile.files[0];
      if (f && f.size > CONFIG.maxSizeMB*1024*1024){ msg.textContent=`Fichier trop lourd (max ${CONFIG.maxSizeMB} Mo).`; msg.className='msg err'; return; }
      // Renommage optionnel
      if (f && CONFIG.renameUploads){
        const ext=extFrom(f.type, f.name.split('.').pop());
        const renamed=new File([f], `${slugify(id)}-${Date.now()}.${ext}`, {type:f.type||'image/jpeg'});
        const dt=new DataTransfer(); dt.items.add(renamed); document.getElementById('photo').files=dt.files;
      }

      const fd=new FormData(form);
      // Joindre aussi les labels utiles côté Make/Sheets
      fd.append('equipe1_label', (labelDom.textContent||'').replace(/^Score\s+/,'')); // Eq1 + Eq1X
      fd.append('equipe2_label', (labelExt.textContent||'').replace(/^Score\s+/,'')); // Eq2 + Eq2X

      // Si l'utilisateur renseigne un temps de jeu => alimenter WinLose avec "20e"
      if (tmin){
        const val = `${parseInt(tmin,10)}e`;
        fd.append('WinLose', val);
        fd.append('en_cours', 'true');
      }else{
        // Sinon, envoyer le statut calculé
        fd.append('WinLose', document.getElementById('statut').value||'');
      }

      try{
        btn.disabled=true; btn.textContent='Envoi…'; msg.textContent='Transmission sécurisée…'; msg.className='msg muted';
        const res=await fetch(CONFIG.webhookScoreUrl,{method:'POST', body:fd});
        if(!res.ok) throw new Error('Webhook score non joignable');
        form.reset();
        document.getElementById('preview').style.display='none';
        selectedBox.hidden=true; idLine.style.display='';
        document.getElementById('temps_jeu').value='';
        msg.textContent='Merci, score envoyé !'; msg.className='msg ok';
      }catch(err){ console.error(err); msg.textContent='Erreur d\'envoi. Vérifiez la connexion et réessayez.'; msg.className='msg err'; }
      finally{ btn.disabled=false; btn.textContent='Envoyer score'; }
    });

    // ---- Soumission PHOTO SUPPLÉMENTAIRE ----
    const form2=document.getElementById('fPhoto');
    const msg2=document.getElementById('msg2');
    const btn2=document.getElementById('btn2');

    form2.addEventListener('submit', async (e)=>{
      e.preventDefault(); msg2.textContent='';
      const file=document.getElementById('photo2').files[0];
      if(!file){ msg2.textContent='Choisissez une photo.'; msg2.className='msg err'; return; }
      if (file && file.size > CONFIG.maxSizeMB*1024*1024){ msg2.textContent=`Fichier trop lourd (max ${CONFIG.maxSizeMB} Mo).`; msg2.className='msg err'; return; }
      // Renommage optionnel
      if (file && CONFIG.renameUploads){
        const ext=extFrom(file.type, file.name.split('.').pop());
        const renamed=new File([file], `${slugify(form2.dataset.mid||'MATCH')}-FINAL-${Date.now()}.${ext}`, {type:file.type||'image/jpeg'});
        const dt=new DataTransfer(); dt.items.add(renamed); document.getElementById('photo2').files=dt.files;
      }

      const fd=new FormData();
      fd.append('match_id', form2.dataset.mid||'');
      fd.append('equipe1_label', form2.dataset.e1||'');
      fd.append('equipe2_label', form2.dataset.e2||'');
      fd.append('meta', form2.dataset.meta||'');
      fd.append('photo_finale', document.getElementById('photo2').files[0]);

      try{
        btn2.disabled=true; btn2.textContent='Envoi…'; msg2.textContent='Transmission sécurisée…'; msg2.className='msg muted';
        const res=await fetch(CONFIG.webhookPhotoUrl,{method:'POST', body:fd});
        if(!res.ok) throw new Error('Webhook photo non joignable');
        form2.reset(); document.getElementById('preview2').style.display='none';
        msg2.textContent='Photo envoyée pour archivage !'; msg2.className='msg ok';
      }catch(err){ console.error(err); msg2.textContent='Erreur d\'envoi. Réessayez.'; msg2.className='msg err'; }
      finally{ btn2.disabled=false; btn2.textContent='Envoyer photo'; }
    });
  </script>
</body>
</html>
