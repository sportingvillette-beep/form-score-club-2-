<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sporting Villette — Scores & Photos</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --brand:#e4362b; --accent:#13b5a6; --deep:#10056b;
      --bg:#f1f1f1; --card:#ffffff; --text:#0f1522; --muted:#4b5565;
      --border:#cfd6df; --chip:#f6f8fb; --wait:#8a6200;
      --ok:#2e7d32; --err:#b00020; --section:#ffffff;
      --shadow:0 6px 20px rgba(16,21,34,.08);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0d1117; --card:#0f141b; --text:#f3f5f8; --muted:#c5ccd6; --border:#2a3748; --chip:#172231; --section:#121926; --ok:#63d39a; --err:#ff6b6b; }
      input,select,button{background:#0f141b;color:var(--text)}
    }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:760px;margin:18px auto;padding:0 14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);padding:18px}
    header{display:flex;align-items:center;gap:12px;margin:6px 0 4px}
    header img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
    .club{font-weight:800;letter-spacing:.2px;font-size:20px}
    .hint{font-size:12px;color:var(--muted)}
    h3{margin:10px 0}

    .day-section{margin:14px 0 8px;border:1px solid var(--border);border-radius:16px;overflow:hidden;background:var(--card)}
    .day-head{position:sticky;top:0;z-index:5;background:var(--section);padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px}
    .day-title{font-weight:900;text-transform:capitalize}
    .day-sub{margin-left:auto;color:var(--muted);font-size:12px}
    .list{display:grid;gap:10px;padding:10px 10px 14px}

    .match-card{width:100%;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px;padding:12px 14px;border:1px solid var(--border);border-radius:14px;background:var(--card);cursor:pointer}
    .match-card:active{transform:scale(.99)}
    .time-box{display:flex;align-items:center;justify-content:center;width:64px;padding:10px;border-radius:12px;background:#e8ecff;border:1px solid #ced6ff;color:var(--deep);font-weight:900;letter-spacing:.2px}
    .teams{display:grid;gap:6px;min-width:0}
    .team-row{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px;min-width:0}
    .team-name{font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text)}
    .team-score{min-width:42px;text-align:right;font-weight:900;color:var(--deep)}
    .meta{display:flex;flex-wrap:wrap;gap:10px;margin-top:4px}
    .meta .category{color:var(--accent);font-weight:900;font-size:14px}
    .meta .other{color:var(--muted)}
    .right{display:flex;align-items:center;gap:8px;justify-self:end;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:800;letter-spacing:.2px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);color:var(--text)}
    .chip-id{color:#2b3447;background:#eef1f6}
    .chip-live{background:#ffe4e2;border-color:#ffc6c2;color:#a41911}
    .chip-wait{background:#fff1cf;border-color:#ffe29b;color:#6d4e00}
    .chip-time{background:#eef5ff;border-color:#d9e6ff;color:#0b3aa7}
    .dot{width:8px;height:8px;border-radius:50%;background:currentColor;opacity:.9}
    .dot::after{content:'';display:block;width:8px;height:8px;border-radius:50%;background:currentColor;opacity:.35;animation:pulse 1.2s infinite ease-out}
    @keyframes pulse{0%{transform:scale(1)}100%{transform:scale(2.2);opacity:0}}

    .thumb{width:56px;height:42px;object-fit:cover;border-radius:8px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .thumb-wrap{display:flex;align-items:center;justify-content:center}
    .thumb-btn{all:unset;cursor:zoom-in}

    .selected{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:10px 0 8px;padding:12px 14px;border:1px dashed var(--border);border-radius:14px;background:#fff}
    .sel-teams{font-weight:900}
    .mini{padding:9px 12px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;border:none;font-weight:800}

    form{display:grid;gap:12px;margin-top:8px}
    label{display:grid;gap:6px;font-size:15px;color:var(--text)}
    input,select,button{font-size:18px;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#fff;color:var(--text)}
    input::placeholder{color:#5a6577}
    input[type="file"]{padding:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row.one{grid-template-columns:1fr}
    .actions{display:grid;gap:8px}
    button{cursor:pointer;background:linear-gradient(135deg,var(--brand),var(--accent));color:#fff;border:none;font-weight:800;border-radius:12px}
    button[disabled]{opacity:.6;cursor:progress}
    .dropzone{border:2px dashed var(--border);border-radius:14px;padding:14px;text-align:center;background:#fff}
    .dropzone.drag{border-color:var(--brand);background:#fff5f5}
    .dz-title{font-size:14px;font-weight:700;color:var(--text)}
    #preview,#preview2{max-width:100%;max-height:220px;border-radius:12px;display:none;margin-top:8px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .muted{color:var(--muted);font-size:12px}
    .msg{min-height:20px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    footer{margin-top:12px;text-align:center}

    @media (max-width:420px){
      .match-card{grid-template-columns:64px 1fr auto}
      .right{grid-column:1 / -1; justify-content:flex-start}
    }
    .lightbox{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50}
    .lightbox.open{display:flex}
    .lightbox img{max-width:92vw;max-height:92vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.5);background:#000}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <img id="clubLogo" alt="Logo du club" src="logo.png" onerror="this.style.display='none'" />
        <div>
          <div class="club" id="clubName">Sporting Villette</div>
          <div class="hint">Saisie du score & photo — mobile</div>
        </div>
      </header>

      <section id="picker" class="matches">
        <h3>Choisir une rencontre</h3>
        <div id="matchesMsg" class="muted">Chargement des matchs…</div>
        <div id="daysContainer"></div>
      </section>

      <div id="selected" class="selected" hidden>
        <div class="sel-top">
          <div class="sel-teams" id="selTeams"></div>
          <div class="muted" id="selMeta"></div>
        </div>
        <button type="button" id="changeBtn" class="mini">Changer</button>
      </div>

      <!-- FORMULAIRE SCORE -->
      <form id="f" novalidate>
        <label id="idLine">ID match
          <input name="match_id" id="match_id" required placeholder="ex: MCH-2025-08-12-001" autocomplete="off">
        </label>

        <label>État du match
          <select name="etat_match" id="etat_match" required>
            <option value="termine" selected>Terminé</option>
            <option value="en_cours">En cours</option>
          </select>
          <span class="muted">Si « En cours », indiquez le temps de jeu.</span>
        </label>

        <div class="row">
          <label><span id="label_dom">Score domicile</span>
            <input type="number" name="score_dom" id="score_dom" inputmode="numeric" min="0" max="200" required>
          </label>
          <label><span id="label_ext">Score extérieur</span>
            <input type="number" name="score_ext" id="score_ext" inputmode="numeric" min="0" max="200" required>
          </label>
        </div>

        <div class="row one" id="temps_wrapper" hidden>
          <label>Temps de jeu (minutes)
            <input type="number" name="temps_jeu" id="temps_jeu" inputmode="numeric" min="1" max="90" placeholder="ex : 20">
          </label>
        </div>

        <label>Résultat (auto)
          <select name="statut" id="statut" required style="pointer-events:none;opacity:.95">
            <option value="" disabled selected>— Calculé automatiquement —</option>
            <option>En cours</option>
            <option>Victoire</option>
            <option>Défaite</option>
            <option>Match Nul</option>
            <option>Terminé</option>
          </select>
        </label>

        <div class="dropzone" id="dz">
          <div class="dz-title">Photo du match (facultatif)</div>
          <input type="file" name="photo" id="photo" accept="image/*">
          <div class="muted">Glissez une image, prenez une photo ou choisissez depuis la galerie.</div>
          <img id="preview" alt="Aperçu photo" />
        </div>

        <input type="hidden" name="form_secret" id="form_secret" value="CHANGE-MOI">

        <div class="actions">
          <button type="submit" id="btn">Envoyer score</button>
          <div class="msg muted" id="msg" role="status" aria-live="polite"></div>
        </div>
      </form>

      <!-- PHOTO FINALE -->
      <form id="fPhoto" class="mt" hidden>
        <h3>Photo supplémentaire (match terminé)</h3>
        <div class="dropzone" id="dz2">
          <div class="dz-title">Ajouter une photo</div>
          <input type="file" name="photo_finale" id="photo2" accept="image/*">
          <div class="muted">Cette photo partira vers l’archivage (Dropbox).</div>
          <img id="preview2" alt="Aperçu photo" />
        </div>
        <div class="actions">
          <button type="submit" id="btn2">Envoyer photo</button>
          <div class="msg muted" id="msg2" role="status" aria-live="polite"></div>
        </div>
      </form>

      <footer class="muted">Astuce : créez un QR code vers cette page. La liste affiche automatiquement les matchs de J-5 à J+2.</footer>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Agrandissement photo">
    <img id="lightboxImg" alt="">
  </div>

  <script>
    const CONFIG = {
      clubName:'Sporting Villette',
      logoUrl:'logo.png',
      webhookScoreUrl:'https://hook.eu2.make.com/12s2f2licqusjj1xiw3p3tulrfnd5dgw',
      webhookPhotoUrl:'https://hook.eu2.make.com/40xiygzru2pfcgwooofj7ewouwqqddsi',
      maxSizeMB:10, renameUploads:true,
      gsheetCsvUrl:'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvskuueB25qKj0hbDWjFPomFdhfWRduUsNLp6Kv-za4t4oXcbbLsLrNsjwIt0ZH7C9B75pYBGDJfQu/pub?gid=0&single=true&output=csv',
      fields:{
        match_id:'Code Gesthand', date:'Date', heure:'Heure',
        categorie:'Catégorie', championnat:'Championnat',
        equipe1:'Eq1', equipe1x:'Eq1X', equipe2:'Eq2', equipe2x:'Eq2X',
        eq1score:'Eq1Score', eq2score:'Eq2Score', winlose:'WinLose',
        gymnase:'Gymnase', ville:'Ville', photo:'PhotoEq'
      },
      clubAliases:['Sporting Villette','Villette Genas','Entente Villette Genas','Est Lyonnais','Lyon Est Handball'],
      dateWindow:{pastDays:5, futureDays:2},
      liveThresholdMin:90
    };

    (function initBrand(){
      if (CONFIG.clubName) document.getElementById('clubName').textContent = CONFIG.clubName;
      if (CONFIG.logoUrl){ const img=document.getElementById('clubLogo'); img.src=CONFIG.logoUrl; }
    })();

    // --- utils
    function norm(s){return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase();}
    function slugify(s){return String(s||'').trim().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').toUpperCase();}
    function extFrom(t,f){if(!t)return f||'jpg'; if(t==='image/jpeg')return'jpg'; if(t==='image/png')return'png'; if(t==='image/webp')return'webp'; if(t==='image/heic'||t==='image/heif')return'heic'; return f||'jpg';}
    function isUrl(u){try{new URL(u);return true;}catch{return false;}}
    function parseDateFR(v){if(!v)return null; const m=String(v).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/); if(m){const d=m[1].padStart(2,'0'),mo=m[2].padStart(2,'0'),y=m[3]; return new Date(`${y}-${mo}-${d}T00:00:00`);} const d=new Date(v); return isNaN(d)?null:d;}
    function parseDateTimeFR(ds,ts){const d=parseDateFR(ds); if(!d)return null; const [h='00',m='00']=String(ts||'00:00').split(':'); const dt=new Date(d); dt.setHours(parseInt(h,10)||0,parseInt(m,10)||0,0,0); return dt;}
    function fmtDate(d){return d?d.toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long'}):'';}
    function fmtTime(d){return d?d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}):'';}
    function sameDay(a,b){return a&&b&&a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
    function inWindow(d){const base=new Date(); base.setHours(0,0,0,0); const s=new Date(base); s.setDate(s.getDate()-(CONFIG.dateWindow.pastDays||5)); const e=new Date(base); e.setDate(e.getDate()+(CONFIG.dateWindow.futureDays||2)); return d>=s && d<=e;}
    function csvToRows(csv){const rows=[];let cur=[],i=0,f='',q=false;while(i<csv.length){const c=csv[i++]; if(c==='"'){if(q && csv[i]==='"'){f+='"';i++;} else q=!q;} else if(c===',' && !q){cur.push(f);f='';} else if((c==='\n'||c==='\r') && !q){ if(f!==''||cur.length){cur.push(f);rows.push(cur);cur=[];f='';} } else f+=c;} if(f!==''||cur.length){cur.push(f);rows.push(cur);} return rows.filter(r=>r.length&&r.join('').trim()!=='']);}

    const matchesMsg=document.getElementById('matchesMsg');
    const daysContainer=document.getElementById('daysContainer');
    const idLine=document.getElementById('idLine');
    const selectedBox=document.getElementById('selected');
    const selTeams=document.getElementById('selTeams');
    const selMeta=document.getElementById('selMeta');
    const changeBtn=document.getElementById('changeBtn');
    const lightbox=document.getElementById('lightbox');
    const lightboxImg=document.getElementById('lightboxImg');

    async function loadMatches(){
      try{
        matchesMsg.textContent='Chargement…';
        const res=await fetch(CONFIG.gsheetCsvUrl,{cache:'no-store'}); if(!res.ok) throw new Error();
        const csv=await res.text(), rows=csvToRows(csv);
        const headers=rows.shift().map(h=>h.trim());
        const idx=Object.fromEntries(headers.map((h,i)=>[h.toLowerCase(),i]));
        const F=CONFIG.fields; const L=Object.fromEntries(Object.entries(F).map(([k,v])=>[k,(v||'').toLowerCase()]));

        const items=rows.map(r=>{
          const d=r[idx[L.date]], h=r[idx[L.heure]], dt=parseDateTimeFR(d,h);
          const e1=(r[idx[L.equipe1]]||'').trim(), e1x=(r[idx[L.equipe1x]]||'').trim();
          const e2=(r[idx[L.equipe2]]||'').trim(), e2x=(r[idx[L.equipe2x]]||'').trim();
          const e1label=(e1+(e1x?` ${e1x}`:'' )).trim(); const e2label=(e2+(e2x?` ${e2x}`:'' )).trim();
          const photo=(r[idx[L.photo]]||'').trim();
          return {
            match_id:r[idx[L.match_id]], date_str:d, heure_str:h, _date:dt,
            categorie:r[idx[L.categorie]], championnat:r[idx[L.championnat]],
            equipe1:e1label, equipe2:e2label,
            eq1score:r[idx[L.eq1score]], eq2score:r[idx[L.eq2score]],
            winlose:r[idx[L.winlose]], gymnase:r[idx[L.gymnase]], ville:r[idx[L.ville]],
            photo:isUrl(photo)?photo:''
          };
        }).filter(x=>x&&x.match_id);

        const filtered=items.filter(x=>x._date && inWindow(new Date(x._date)));

        filtered.sort((a,b)=>{
          const rank=d=>d.getDay()===6?1:d.getDay()===0?2:3;
          const ra=rank(a._date), rb=rank(b._date);
          if(ra!==rb) return ra-rb;
          if(a._date.toDateString()!==b._date.toDateString()) return a._date-b._date;
          return a._date-b._date;
        });

        window.__csv_cache={rows,idx,fields:L,headers};
        renderDays(filtered);
        matchesMsg.textContent='';
      }catch{ matchesMsg.textContent="Impossible de charger la liste des matchs."; }
    }

    function parseMinute(winlose){
      if(!winlose) return null;
      const m=String(winlose).trim().match(/^(\d{1,2})\s*e$/i);
      return m?parseInt(m[1],10):null;
    }
    function isFinished(winlose){
      if(!winlose) return false;
      const w=String(winlose);
      return /(victoire|defaite|défaite|match\s*nul|termine|terminé)/i.test(w);
    }

    // Règles d'affichage demandées
    function rightChipsForMatch(m){
      const chips=[];
      const now=new Date();
      const start=m._date;
      const minsSinceStart = (start && now>start)? Math.floor((now-start)/60000) : null;
      const s1 = (m.eq1score!=null && String(m.eq1score).trim()!=='') ? Number(m.eq1score) : null;
      const s2 = (m.eq2score!=null && String(m.eq2score).trim()!=='') ? Number(m.eq2score) : null;
      const hasScore = (s1!==null && s2!==null);
      const minute = parseMinute(m.winlose);
      const finished = isFinished(m.winlose);

      if (!hasScore){
        if (start && sameDay(start, now) && minsSinceStart!==null && !finished){
          if (minsSinceStart <= 90) chips.push(`<span class="chip chip-live"><span class="dot"></span> LIVE</span>`);
          else chips.push(`<span class="chip chip-wait">Attente score final</span>`);
        }
      } else {
        if (minute!=null){               // en cours avec temps dans WinLose
          if (start && minsSinceStart!==null && minsSinceStart > 120){
            chips.push(`<span class="chip chip-wait">Attente score final</span>`);
          }else{
            chips.push(`<span class="chip chip-time">${minute}e</span>`);
          }
        } else if (finished){            // statut final écrit dans WinLose
          const label = String(m.winlose).trim();
          chips.push(`<span class="chip">${label}</span>`);
        }
      }
      chips.push(`<span class="chip chip-id">${m.match_id}</span>`);
      if (m.photo){
        chips.push(`<span class="thumb-wrap"><button class="thumb-btn" data-photo="${m.photo}" aria-label="Agrandir la photo" onclick="event.stopPropagation();openLightbox('${m.photo}')"><img class="thumb" src="${m.photo}" alt="Photo du match"></button></span>`);
      }
      return chips.join('');
    }

    function groupByDay(list){
      const groups={};
      for(const m of list){
        const key=new Date(m._date.getFullYear(),m._date.getMonth(),m._date.getDate()).toISOString();
        (groups[key] ||= []).push(m);
      }
      Object.values(groups).forEach(arr=>arr.sort((a,b)=>a._date-b._date));
      const keys=Object.keys(groups).sort((ka,kb)=>{
        const a=new Date(ka), b=new Date(kb);
        const rank=d=>d.getDay()===6?1:d.getDay()===0?2:3;
        const ra=rank(a), rb=rank(b);
        if(ra!==rb) return ra-rb;
        return a-b;
      });
      return {keys,groups};
    }

    function renderDays(list){
      const container=daysContainer; container.innerHTML='';
      if(!list.length){ matchesMsg.textContent='Aucun match dans la fenêtre sélectionnée.'; return; }
      const {keys,groups}=groupByDay(list);
      const frag=document.createDocumentFragment();

      for(const k of keys){
        const d=new Date(k);
        const sec=document.createElement('div'); sec.className='day-section';
        const head=document.createElement('div'); head.className='day-head';
        const title=document.createElement('div'); title.className='day-title'; title.textContent=fmtDate(d);
        const sub=document.createElement('div'); sub.className='day-sub'; sub.textContent=`${groups[k].length} match${groups[k].length>1?'s':''}`;
        head.appendChild(title); head.appendChild(sub);

        const listEl=document.createElement('div'); listEl.className='list';
        groups[k].forEach(m=>{
          const s1 = (m.eq1score!=null && String(m.eq1score).trim()!=='') ? Number(m.eq1score) : null;
          const s2 = (m.eq2score!=null && String(m.eq2score).trim()!=='') ? Number(m.eq2score) : null;

          const card=document.createElement('button'); card.type='button'; card.className='match-card';
          card.innerHTML=`
            <div class="time-box">${fmtTime(m._date)}</div>
            <div class="teams">
              <div class="team-row">
                <div class="team-name">${(m.equipe1||'').trim()}</div>
                <div class="team-score">${s1!==null ? s1 : ''}</div>
              </div>
              <div class="team-row">
                <div class="team-name">${(m.equipe2||'').trim()}</div>
                <div class="team-score">${s2!==null ? s2 : ''}</div>
              </div>
              <div class="meta">
                ${m.categorie?`<span class="category">${m.categorie}</span>`:''}
                ${m.championnat?`<span class="other">${m.championnat}</span>`:''}
                ${m.ville?`<span class="other">${m.ville}</span>`:''}
              </div>
            </div>
            <div class="right">${rightChipsForMatch(m)}</div>`;
          card.addEventListener('click',()=>selectMatch(m));
          listEl.appendChild(card);
        });

        sec.appendChild(head); sec.appendChild(listEl);
        frag.appendChild(sec);
      }
      container.appendChild(frag);
    }

    // Lightbox
    function openLightbox(src){ lightboxImg.src=src; lightbox.classList.add('open'); }
    function closeLightbox(){ lightbox.classList.remove('open'); lightboxImg.src=''; }
    lightbox.addEventListener('click', closeLightbox);
    window.openLightbox=openLightbox;

    // --- sélection + formulaire
    const labelDom=document.getElementById('label_dom');
    const labelExt=document.getElementById('label_ext');
    const inputId=document.getElementById('match_id');
    const sdEl=document.getElementById('score_dom');
    const seEl=document.getElementById('score_ext');
    const statutEl=document.getElementById('statut');
    const etatEl=document.getElementById('etat_match');
    const tempsWrap=document.getElementById('temps_wrapper');
    const tempsEl=document.getElementById('temps_jeu');

    function setTeamLabels(eq1,eq2){ if(eq1) labelDom.textContent=`Score ${eq1}`; if(eq2) labelExt.textContent=`Score ${eq2}`; }

    const CLUBS=(CONFIG.clubAliases||[]).map(norm);

    // Calcule le résultat UNIQUEMENT si l'état est "Terminé".
    function computeResult(){
      const etat = etatEl.value;
      if (etat === 'en_cours'){
        statutEl.value = 'En cours';           // affichage uniquement
        return;
      }
      const s1=parseInt(sdEl.value,10), s2=parseInt(seEl.value,10);
      if(Number.isNaN(s1)||Number.isNaN(s2)){ statutEl.value=''; return; }
      if(s1===s2){ statutEl.value='Match Nul'; return; }
      const eq1=(labelDom.textContent||'').replace(/^Score\s+/,''), eq2=(labelExt.textContent||'').replace(/^Score\s+/,'');

      const isClub1=CLUBS.some(a=>norm(eq1).includes(a));
      const isClub2=CLUBS.some(a=>norm(eq2).includes(a));
      if(s1>s2){ if(isClub1) statutEl.value='Victoire'; else if(isClub2) statutEl.value='Défaite'; else statutEl.value='Terminé'; }
      else { if(isClub2) statutEl.value='Victoire'; else if(isClub1) statutEl.value='Défaite'; else statutEl.value='Terminé'; }
    }

    // Montre/cache le champ temps et met le statut affiché
    function toggleTempsByEtat(){
      const enCours = etatEl.value==='en_cours';
      tempsWrap.hidden = !enCours;
      if (!enCours) tempsEl.value='';
      computeResult();
    }
    etatEl.addEventListener('change', toggleTempsByEtat);
    // si on tape un temps, force "En cours"
    tempsEl.addEventListener('input', ()=>{
      if (String(tempsEl.value).trim()!==''){
        etatEl.value='en_cours';
        toggleTempsByEtat();
      }
    });

    function selectMatch(m){
      selTeams.textContent=`${(m.equipe1||'').trim()} vs ${(m.equipe2||'').trim()}`;
      selMeta.textContent=[fmtDate(m._date), fmtTime(m._date), (m.categorie||''), (m.championnat||''), (m.ville||'')].filter(Boolean).join(' · ');
      selectedBox.hidden=false; idLine.style.display='none';
      document.getElementById('match_id').value=m.match_id||'';
      setTeamLabels(m.equipe1,m.equipe2);

      // Si WinLose correspond à "XXe" -> En cours côté affichage
      if (parseMinute(m.winlose)!=null){ etatEl.value='en_cours'; statutEl.value='En cours'; }
      else { etatEl.value='termine'; computeResult(); }
      toggleTempsByEtat();
      document.getElementById('f').scrollIntoView({behavior:'smooth',block:'start'});
    }

    changeBtn.addEventListener('click',()=>{
      selectedBox.hidden=true; idLine.style.display='';
      document.getElementById('match_id').value='';
      setTeamLabels('domicile','extérieur'); statutEl.value='';
      etatEl.value='termine'; toggleTempsByEtat();
      document.getElementById('fPhoto').hidden=true;
    });

    async function lookupTeamsById(id){
      try{
        const c=window.__csv_cache; if(!c) return;
        const F=c.fields;
        const mi=c.idx[(F.match_id||'')];
        const e1=c.idx[(F.equipe1||'')], e1x=c.idx[(F.equipe1x||'')];
        const e2=c.idx[(F.equipe2||'')], e2x=c.idx[(F.equipe2x||'')];
        const row=c.rows.find(r=>String(r[mi]).trim()===id.trim());
        if(row){
          const e1label=[row[e1],row[e1x]].filter(Boolean).join(' ').trim();
          const e2label=[row[e2],row[e2x]].filter(Boolean).join(' ').trim();
          setTeamLabels(e1label,e2label);
        }
      }catch{}
    }

    (function prefill(){
      const p=new URLSearchParams(location.search);
      const id=p.get('match_id'); if(id){ inputId.value=id; }
      const e1=p.get('eq1'), e2=p.get('eq2'); if(e1||e2) setTeamLabels(e1,e2);
      toggleTempsByEtat();
    })();

    let t=null; const inputId=document.getElementById('match_id');
    inputId.addEventListener('input',()=>{clearTimeout(t);const id=inputId.value.trim();if(!id)return;t=setTimeout(()=>lookupTeamsById(id),400);});
    inputId.addEventListener('blur',()=>{const id=inputId.value.trim();if(id)lookupTeamsById(id);});
    document.getElementById('score_dom').addEventListener('input', computeResult);
    document.getElementById('score_ext').addEventListener('input', computeResult);

    loadMatches();

    // Drag & drop + preview
    ;(function dz1(){const dz=document.getElementById('dz'), file=document.getElementById('photo'), prev=document.getElementById('preview');
      ['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.add('drag')}));
      ['dragleave','drop'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.remove('drag')}));
      dz.addEventListener('drop',e=>{ if(e.dataTransfer.files?.length){ file.files=e.dataTransfer.files; file.dispatchEvent(new Event('change')); } });
      file.addEventListener('change',()=>{ const f=file.files[0]; if(!f){ prev.style.display='none'; prev.src=''; return; } prev.src=URL.createObjectURL(f); prev.style.display='block'; });
    })();
    ;(function dz2(){const dz=document.getElementById('dz2'), file=document.getElementById('photo2'), prev=document.getElementById('preview2');
      ['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.add('drag')}));
      ['dragleave','drop'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.remove('drag')}));
      dz.addEventListener('drop',e=>{ if(e.dataTransfer.files?.length){ file.files=e.dataTransfer.files; file.dispatchEvent(new Event('change')); } });
      file.addEventListener('change',()=>{ const f=file.files[0]; if(!f){ prev.style.display='none'; prev.src=''; return; } prev.src=URL.createObjectURL(f); prev.style.display='block'; });
    })();

    // submit score
    const form=document.getElementById('f'), msg=document.getElementById('msg'), btn=document.getElementById('btn');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault(); msg.textContent='';
      const id=document.getElementById('match_id').value.trim();
      const sd=document.getElementById('score_dom').value;
      const se=document.getElementById('score_ext').value;
      if(!id||sd===''||se===''){ msg.textContent='Merci de compléter tous les champs requis.'; msg.className='msg err'; return; }

      const etat=document.getElementById('etat_match').value;
      const tmin=document.getElementById('temps_jeu').value.trim();

      // fichiers
      const inputFile=document.getElementById('photo'); const f=inputFile.files[0];
      if (f && f.size > CONFIG.maxSizeMB*1024*1024){ msg.textContent=`Fichier trop lourd (max ${CONFIG.maxSizeMB} Mo).`; msg.className='msg err'; return; }
      if (f && CONFIG.renameUploads){ const ext=extFrom(f.type, f.name.split('.').pop()); const renamed=new File([f], `${slugify(id)}-${Date.now()}.${ext}`, {type:f.type||'image/jpeg'}); const dt=new DataTransfer(); dt.items.add(renamed); document.getElementById('photo').files=dt.files; }

      const fd=new FormData(form);

      // Infos supplémentaires utiles côté Make
      fd.append('equipe1_label', (labelDom.textContent||'').replace(/^Score\s+/,'')); 
      fd.append('equipe2_label', (labelExt.textContent||'').replace(/^Score\s+/,'')); 

      if (etat==='en_cours'){
        if(!tmin){ msg.textContent='Indiquez le temps de jeu (minutes).'; msg.className='msg err'; return; }
        // >>> IMPORTANT : WinLose = temps de jeu (ex: 20e)
        fd.set('WinLose', `${parseInt(tmin,10)}e`);
        // Optionnel : statut pour affichage seulement
        fd.set('statut', 'En cours');
        fd.append('en_cours','true');
      } else {
        // Statut final calculé (Victoire/Défaite/Nul) uniquement quand terminé
        computeResult();
        fd.set('WinLose', document.getElementById('statut').value||'');
      }

      try{
        btn.disabled=true; btn.textContent='Envoi…'; msg.textContent='Transmission sécurisée…'; msg.className='msg muted';
        const res=await fetch(CONFIG.webhookScoreUrl,{method:'POST', body:fd});
        if(!res.ok) throw new Error('Webhook score non joignable');
        form.reset(); document.getElementById('preview').style.display='none';
        selectedBox.hidden=true; idLine.style.display='';
        document.getElementById('temps_jeu').value=''; document.getElementById('etat_match').value='termine'; 
        msg.textContent='Merci, score envoyé !'; msg.className='msg ok';
      }catch(err){ console.error(err); msg.textContent='Erreur d\'envoi. Vérifiez la connexion et réessayez.'; msg.className='msg err'; }
      finally{ btn.disabled=false; btn.textContent='Envoyer score'; }
    });

    // photo finale
    const form2=document.getElementById('fPhoto'), msg2=document.getElementById('msg2'), btn2=document.getElementById('btn2');
    form2.addEventListener('submit', async (e)=>{
      e.preventDefault(); msg2.textContent='';
      const file=document.getElementById('photo2').files[0];
      if(!file){ msg2.textContent='Choisissez une photo.'; msg2.className='msg err'; return; }
      if (file && file.size > CONFIG.maxSizeMB*1024*1024){ msg2.textContent=`Fichier trop lourd (max ${CONFIG.maxSizeMB} Mo).`; msg2.className='msg err'; return; }
      if (file && CONFIG.renameUploads){ const ext=extFrom(file.type, file.name.split('.').pop()); const renamed=new File([file], `${slugify(form2.dataset.mid||'MATCH')}-FINAL-${Date.now()}.${ext}`, {type:file.type||'image/jpeg'}); const dt=new DataTransfer(); dt.items.add(renamed); document.getElementById('photo2').files=dt.files; }
      const fd=new FormData();
      fd.append('match_id', form2.dataset.mid||''); fd.append('equipe1_label', form2.dataset.e1||''); fd.append('equipe2_label', form2.dataset.e2||''); fd.append('meta', form2.dataset.meta||''); fd.append('photo_finale', document.getElementById('photo2').files[0]);
      try{
        btn2.disabled=true; btn2.textContent='Envoi…'; msg2.textContent='Transmission sécurisée…'; msg2.className='msg muted';
        const res=await fetch(CONFIG.webhookPhotoUrl,{method:'POST', body:fd});
        if(!res.ok) throw new Error('Webhook photo non joignable');
        form2.reset(); document.getElementById('preview2').style.display='none';
        msg2.textContent='Photo envoyée pour archivage !'; msg2.className='msg ok';
      }catch(err){ console.error(err); msg2.textContent='Erreur d\'envoi. Réessayez.'; msg2.className='msg err'; }
      finally{ btn2.disabled=false; btn2.textContent='Envoyer photo'; }
    });

    // helpers lightbox
    function openLightbox(src){ lightboxImg.src=src; lightbox.classList.add('open'); }
    function closeLightbox(){ lightbox.classList.remove('open'); lightboxImg.src=''; }
    lightbox.addEventListener('click', closeLightbox);

    // charger la liste
    loadMatches();
  </script>
</body>
</html>
